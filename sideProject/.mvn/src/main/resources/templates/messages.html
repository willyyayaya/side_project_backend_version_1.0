<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/message.css}">

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
        integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"
        integrity="sha384-ODmDIVzN+pFdexxHEHFBQH3/9/vQ9uori45z4JjnFsRydbmQbmL5t1tQ0culUzyK"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="CSS/fragment.css">
    <link rel="stylesheet" href="/sideProject/src/main/resources/static/CSS/register.css">
</head>

<body>
    <div class="sticky" th:if="${member == null}" th:insert="fragments::header"></div>
    <div class="sticky" th:if="${member!= null}" th:insert="fragments::userHeader"></div>

<form th:action="@{/message/{receiverid}}" method="post" enctype="multipart/form-data">

    <div id="message">
        <div id="mesgtop">
            <div id="alld">
                <a th:href="@{/message/${member.memberid}}" id="home">站內信</a>
			    <a href="/send" id="tegami">寫信</a>
            </div>
            <br>
            <br>
            <br>
            <hr>
            <div id="mesgdown">
                    <table id="messageTable">
				        <thead>
				            <tr>
				                <th>寄件人</th>
				                <th>標題</th>
				                <th>日期</th>
				                <th>已讀</th>
				            </tr>
				        </thead>
				         <tbody id="messageTableBody">
					        <!-- 遍歷 messages -->
					            <!-- 表頭 -->
					        <tr th:each="message : ${messages}" class="collapsible-header" >
					            <td th:text="${message.senderid.name}">1號會員</td>
					            <td th:text="${message.title}">測試信件</td>
					            <td th:text="${message.createdat}">2025.1.1</td>
					            <td th:text="${message.isread ? '已讀' : '未讀'}">已讀</td>
					        </tr>
					        <!-- 摺疊內容 -->
					        <tr class="collapsible-content"  th:each="message : ${messages}" style="display:none;" id="content">
					            <td colspan="3">
					                <div id="mymesg">
					                    <div class="content">
					                        <p th:text="${message.content}">
					                            這裡會顯示詳細內容
					                        </p>
					                    </div>
					                    <button id="del">刪除</button>
					                    <button id="back"  data-sender-id="${senderid.memberid}">回信</button>
					                </div>
					            </td>
					        </tr>
					        
					    </tbody>

				    </table>

                </div>
                <!-- //---------------------------- -->
            <!--<button id="pageup">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#eaeff3" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left" style="background-color: #14518e;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <button id="pagedown">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#eaeff3" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right" style="background-color: #14518e;"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>  -->
        </div>
    </div>
</form>
    <div th:replace="fragments::footer"></div>

<script>
$(document).ready(function() {
    // 綁定點擊事件
    $('.collapsible-header').on('click', function() {
        const contentRow = $(this).next('#content'); // 取得下一個 <tr> 元素
        contentRow.toggle();  // 切換顯示或隱藏
    });

    // 預設隱藏所有內容行
    $('.collapsible-content').hide();
});
//刪除信件    
$(document).ready(function() {
	$('#del').click(function() {
		const messageId = 
			$.ajax({
				url: `/deleteMessage/${messageId}`,
				type: 'DELETE',
				success: function(result) {
					alert(result);
					console.log(result);
				},
				error: function(xhr, status, error) {
					alert('刪除失敗');
					console.error('錯誤:', error);
				}
			});
	});
});

//回覆信件
$(document).ready(function() {
            $('#back').click(function() {
                var senderId = $(this).data('sender-id'); // 從按鈕的 data-attribute 獲取 senderId
                var messageContent = $('#messageContent').val(); // 獲取回信內容

                // 發送 Ajax 請求
                $.ajax({
                    url: '/reply',
                    method: 'POST',
                    data: {
                        senderId: senderId,
                        messageContent: messageContent
                    },
                    success: function(response) {
                        // 顯示成功訊息
                        $('#responseMessage').html('<p>回信成功: ' + response + '</p>');
                    },
                    error: function(xhr, status, error) {
                        // 顯示錯誤訊息
                        $('#responseMessage').html('<p>回信失敗: ' + error + '</p>');
                    }
                });
            });
        });

</script>
</body>

</html>